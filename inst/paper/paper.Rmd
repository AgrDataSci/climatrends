---
title: 'Climate variability indices for ecological and crop models in R: the `climatrends` package'
tags:
- climate data
- climatology
- earth science
- evapotranspiration
- precipitation data
- R
- reproducibility
- weather data
authors:
  - name: Kauê de Sousa
    orcid: 0000-0002-7571-7845
    affiliation: "1, 2"
  - name: Jacob van Etten
    orcid: 0000-0001-7554-2558
    affiliation: 2
  - name: Svein Ø. Solberg
    orcid: 0000-0002-4491-4483
    affiliation: 1
affiliations:
  - name: Department of Agricultural Sciences, Inland Norway University of Applied Sciences, Hamar, Norway
    index: 1
  - name: Bioversity International, Rome, Italy
    index: 2
citation_author: de Sousa et. al.
date: "`r format(Sys.time(), '%d %B %Y')`"
year: 2020
bibliography: paper.bib
output: pdf_document
---

```{r get data, include=FALSE}
library("knitr")
library("kableExtra")
library("tidyverse")
library("climatrends")
library("PlackettLuce")
funtbl <- read.csv("available_functions.csv")
load("inst/paper/cbean.rda")
```


>Kauê de Sousa^1,2[*]^, Jacob van Etten^2^, Svein Øivind Solberg^1^  
^1^ Department of Agricultural Sciences, Inland Norway University of Applied Sciences, 2318 Hamar, Norway  
^2^ Bioversity International, 00054 Maccarese, Rome, Italy  
^[*]^Correspondence should be addressed to: <kaue.desousa@inn.no>

\

# Introduction

Abiotic factors plays an important role in most ecological and crop systems that depends on certain levels of temperature, light and precipitation (and their interplay) to initiate important physiological events [@PlantEcology]. In the walk of climate change, understand how these factors drives the physiological processes is a key approach to provide recommendations for adaptation and biodiversity conservation. If translated to stress 

Raw temperature and precipitation values are ... to describe how organisms interacts with the enviroment

**climatrends** aims to provide the R [@RCoreTeam] toolkit to compute extreme precipitation and temperature indices that serves as input for climate and crop models [@vanEtten2019; @Kehel2016], trends in climate change [@Aguilar2005; @deSousa2018] and applied ecology [@Prentice1992; @YLiu2018].

[...continue...]

# Methods and features

## Implementation

Six main functions are provided, `crop_sensitive()`, `ETo()`, `GDD()`, `late_frost()`, `rainfall()` and `temperature()` with a default method for numeric 'vector's and additional methods implemented via the package `methods` [@RCoreTeam] for classes 'matrix' (or array), 'data.frame', and 'sf' (of geometry POINT or POLYGON) [@sf]. The later two are designed to fetch data from cloud sources. 



say that the idea for the functions started with citizen science projects that is why `day.one` and `span` may be variable across locations. For time series analysis where fixed periods are defined across many locations the indices can be adjusted with last.day. 

[...continue...]


```{r characteristics, echo=FALSE, message=TRUE}
kable(funtbl, 
      row.names = FALSE,
      align = "l", 
      caption = "Main functions available in climatrends.") %>% 
  kable_styling(latex_options = "scale_down") %>% 
  column_spec(2, width = "1in") %>% 
  column_spec(3, width = "1.7in") %>% 
  column_spec(4, width = "1.7in")
```

## Temperature and precipitation indices



## Growing degree-days

Growing degree-days (gdd) is an heuristic tool in phenology that measures heat accumulation and is used to predict plant and animal development rates [@Prentice1992]. Growing degree-days are calculated by taking the integral of warmth above a base temperature ($T_{0}$). The function `GDD()` applies by default the following equation.

Equation [1]

$$GDD = \frac{T_{max} + T_{min}}{2} - T_{0}$$

Where $T_{max}$ is the maximum temperature in the given day, $T_{min}$ is the minimum temperature in the given day and $T_{0}$ is the minimum temperature for growth (as per the physiology of the focal organism or ecosystem averages). 

Additionally, the function `GDD()` offers three modified equations designed for cold environments and for tropical environments. For cold environments, where $T_{min}$ may be lower than $T_{0}$, there are two modified equations that adjusts either $T_{mean}$ (variant a) or $T_{min}$ (variant b). The variant a changes $T_{mean}$ to $T_{0}$ if $T_{mean} < T_{0}$ and is expressed as follows.

Equation [2]

$$ GDD = max \left(\frac{T_{max} + T_{min}}{2} - T_{0}, \; 0 \right)$$

The variant b, is calculated using Equation 1, but adjusts $T_{min}$ or $T_{max}$ to $T_{0}$ if $T < T_{0}$, the equation is adjusted as follows.

Equation [3]

$$ T < T_{0} \; \rightarrow \; T = T_{0} $$

Where $T$ may refer to $T_{min}$ and/or $T_{max}$ when the condition of being below $T_{0}$ applies.

For tropical areas, where the temperature may surpass a maximum threshold ($T_{0^{max}}$), resulting in limited development, the minimum temperature is adjusted using Equation 3 and the maximum temperature is adjusted to a maximum base temperature as follow.

Equation [4]

$$ T_{max} > T_{0^{max}} \; \rightarrow \; T_{max} = T_{0^{max}} $$

Where $T_{0^{max}}$ is the maximum base temperature for growth, defined in `GDD()` using the argument `tbase_max`.

These modified equations are defined as 'a', 'b' and 'c', respectively, and can be selected using the argument `equation`.

By default, the function returns the degree-days that is accumulated over the time series using Equation 1. Additionally, the function may return the daily values of degree-days or the number of days that a given organism required to reach a certain number of accumulated degree-days. These values are defined by 'acc', 'daily' or 'ndays' and can be adjusted using the argument `return.as`. The required accumulated gdd is defined with argument `degree.days`. For example, the Korean pine (*Pinus koraiensis*) requires 105 $^\circ C$ accumulated gdd to onset the photosynthesis [@JWu2013]. In that case, `GDD()` will calculate the growing degree-days ($gdd$) and sum up the values until it reaches 105 $^\circ C$ and return the number of days required in the given season ($GDD_{r}$), as follows.

Equation [5]

$$\parallel GDD_{r} \parallel \: = \; ggd_1 \;+ \; ...  \; +  \; gdd_n$$

## Late-spring frost

## Crop-related indices

Two functions in **climatrends** are mainly designed to capture the effects of climate on the development and stress of crop species, `crop_sensitive` computes indices that aims to capture the changes in temperature extremes during key phenological stages (e.g. anthesis), and `ETo()` computes the reference evapotranspiration. 

The reference evapotranspiration measures the influence of the climate on a given organism water needs, generally a crop species [@Brouwer1986]. The function `ETo()` applies the Blaney-Criddle method, a general theoretical method used when only air-temperature is available locally. It should be noted that this method is not very accurate and aims to provide the order of magnitude of evapotranspitation. The reference evapotranspiration is calculated using the following equation.

Equation [6]

$$ETo = p \times \left(0.46 \times \frac{T_{max} + T_{min}}{2} + 8 \right) \times K_c$$

Where $p$ is the mean daily percentage of annual daytime hours, $T_{max}$ is the maximum temperature, $T_{min}$ is the minimum temperature, and $K_c$ is the factor for organism water need.

The percentage of daytime hours ($p$) is calculated internally by the 'data.frame' and 'sf' methods in `ETo()` using the given latitude (taken from the inputted `object`) and date (taken from the inputted `day.one`). It matches the latitude and date with a table of daylight percentage derived from Brouwer and Heibloem [-@Brouwer1986]. The table can be verified using `climatrends:::daylight`.

# Examples

## Common beans

Replicate part of the analysis in van Etten et al [-@vanEtten2019] with the beans data to show how we can use this package to capture the influence of climate variability on crop performance. The idea is to show the same PlackettLuce Tree.

```{r }
```

## Time series 

Pick some random points in Norway (or Scandinavia??) and check how the trends on temperature indices over the last 20 years. 

## Seed germination or some GDD related analysis

Use the data from seed germination or crop growth to compute GDD. How many GDD a seed need to become a seedling?

# Further development

Integration with other datasets as they become available in `R` via API client packages. New indices related to the physiology of crops to be implemented while I work on the rice data.

# Acknowledgements

This work was supported by The Nordic Joint Committee for Agricultural and Food Research (grant num. 202100-2817).

# Authors' contributions

KdS and JvE conceived the ideas of implementing an `R` package. JvE and SØS assisted in the implementation of methods. KdS wrote and documented the software. [add other contributions...]

# Data availability statement

The source code has been archived at [**add link**] as `climatrends` version **X.Y.Z**. To explore the latest functionalities of `climatrends`, please check the package's updates at CRAN (https://cran.r-project.org/package=climatrends).

# References